<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>frp浅改记录 - ?___?</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="frp改造已经有很多了，一开始用的@unknownsec师傅的modify，由于一些版本及其他一些原因，打算自己研究研究。" /><meta name="keywords" content='frp, golang' /><meta itemprop="name" content="frp浅改记录">
<meta itemprop="description" content="frp改造已经有很多了，一开始用的@unknownsec师傅的modify，由于一些版本及其他一些原因，打算自己研究研究。"><meta itemprop="datePublished" content="2022-12-22T21:13:01+00:00" />
<meta itemprop="dateModified" content="2022-12-22T21:13:01+00:00" />
<meta itemprop="wordCount" content="3913"><meta itemprop="image" content="http://example.org/logo.png"/>
<meta itemprop="keywords" content="frp,golang," /><meta property="og:title" content="frp浅改记录" />
<meta property="og:description" content="frp改造已经有很多了，一开始用的@unknownsec师傅的modify，由于一些版本及其他一些原因，打算自己研究研究。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/frp/" /><meta property="og:image" content="http://example.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-22T21:13:01+00:00" />
<meta property="article:modified_time" content="2022-12-22T21:13:01+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/logo.png"/>

<meta name="twitter:title" content="frp浅改记录"/>
<meta name="twitter:description" content="frp改造已经有很多了，一开始用的@unknownsec师傅的modify，由于一些版本及其他一些原因，打算自己研究研究。"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/frp/" /><link rel="prev" href="http://example.org/posts/ciscn-web-filter/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "frp浅改记录",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/example.org\/posts\/frp\/"
    },"genre": "posts","keywords": "frp, golang","wordcount":  3913 ,
    "url": "http:\/\/example.org\/posts\/frp\/","datePublished": "2022-12-22T21:13:01+00:00","dateModified": "2022-12-22T21:13:01+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "le3teq"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="?___?"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="?___?"
    title="?___?"/><span class="header-title-text">le3tq&#39; blog</span></a><span id="typeit-header-subtitle-desktop" class="typeit header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-archive fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="?___?"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/fixit.min.svg"
    data-srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x"
    data-sizes="auto"
    alt="/fixit.min.svg"
    title="/fixit.min.svg"/><span class="header-title-text">le3tq&#39; blog</span></a><span id="typeit-header-subtitle-mobile" class="typeit header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-archive fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-circle fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container-reverse" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>frp浅改记录</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      le3teq</span></span>
          <span class="post-category">收录于 <a href="/categories/%E4%BB%A3%E7%90%86tools/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 代理Tools</a></span></div>
      <div class="post-meta-line"><span title=2022-12-22&#32;21:13:01><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-12-22">2022-12-22</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 3913 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 8 分钟</span>&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="frp浅改记录">
            <i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
          </span>&nbsp;</div>
    </div><div class="featured-image"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://s2.loli.net/2022/12/21/q7BNuCyn3O1a2Gb.png"
    data-srcset="https://s2.loli.net/2022/12/21/q7BNuCyn3O1a2Gb.png, https://s2.loli.net/2022/12/21/q7BNuCyn3O1a2Gb.png 1.5x, https://s2.loli.net/2022/12/21/q7BNuCyn3O1a2Gb.png 2x"
    data-sizes="auto"
    alt="https://s2.loli.net/2022/12/21/q7BNuCyn3O1a2Gb.png"
    title="https://s2.loli.net/2022/12/21/q7BNuCyn3O1a2Gb.png"/></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#加载逻辑分析">加载逻辑分析</a>
      <ul>
        <li><a href="#文件解析">文件解析</a></li>
        <li><a href="#客户端运行">客户端运行</a></li>
      </ul>
    </li>
    <li><a href="#改动思路">改动思路</a></li>
    <li><a href="#代码实现部分">代码实现部分</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><p>frp改造已经有很多了，一开始用的@unknownsec师傅的modify，由于一些版本及其他一些原因，打算自己研究研究。</p>
<h2 id="前言">前言</h2>
<p>主要修改的无落地。参考网上的一些文章，发现都是直接硬修改（之前的配置文件功能会失效），包括版本问题导致用不了。这次修改打算在原有基础上添加指定参数，并进行<code>aes</code>加密，思路都是网上的，本次主要是实现软修改，不破坏之前的功能。</p>
<h2 id="加载逻辑分析">加载逻辑分析</h2>
<h3 id="文件解析">文件解析</h3>
<p>入口文件在<code>cmd/frpc/main.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sub</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>sub.Execute</code>来自于<code>cmd/frpc/sub/root.go:146</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Execute</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>rootCmd.Execute</code>来自于<code>cmd/frpc/sub/root.go:100</code>,rootCmd是一个<code>cobra.Command</code>的重写接口，主要关注<code>RunE</code>的内容即可。关注主要内容如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rootCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">......</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cfgDir</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">......</span>
</span></span><span class="line"><span class="cl">					<span class="k">defer</span> <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">					<span class="nx">err</span> <span class="o">:=</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">...</span><span class="p">..</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Do not show command usage here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">err</span> <span class="o">:=</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>runClient</code>用来启动frp客户端，代码中表示支持非当前目录文件。在<code>cmd/frpc/sub/root.go:192</code>跟进这个函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">cfgFilePath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">cfgFilePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">startService</span><span class="p">(</span><span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">cfgFilePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>传入的配置文件被<code>ParseClientConfig</code>解析，然后通过<code>startService</code>启动服务。这里我们先跟进<code>ParseClientConfig</code>函数</p>
<p>在<code>pkg/config/parse.go:24</code>找到它。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span> <span class="nx">ClientCommonConf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pxyCfgs</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">ProxyConf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">visitorCfgs</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">VisitorConf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="kt">error</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">content</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="p">..</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">UnmarshalClientConfFromIni</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="p">..</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Parse all proxy and visitor configs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">LoadAllProxyConfsFromIni</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span> <span class="nx">configBuffer</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(),</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">Start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>主要流程是<code>GetRenderedConfFromFile</code>读取文件内容，<code>UnmarshalClientConfFromIni</code>负责对内容进行解析。</p>
<p>首先是<code>GetRenderedConfFromFile</code>,主要是一个io的操作和对配置文件进行模板检测（<code>RenderContent</code>），很多frp配置文件改动都基于此(这里的<code>b</code>参数就是<code>frpc.ini</code>文件的源内容)。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">out</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">RenderContent</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>通过前面大概能得出解析过程</p>
<pre tabindex="0"><code>sub.Execute() -&gt; rootCmd.Execute() -&gt; runClient(cfgFile) -&gt; config.ParseClientConfig(cfgFilePath) -&gt; GetRenderedConfFromFile(filePath) -&gt; UnmarshalClientConfFromIni(content)
</code></pre><p>简单来说返回的就是把文件解析成一个<code>map</code>，通过自定义结构体来读取对应端口、ip协议。</p>
<h3 id="客户端运行">客户端运行</h3>
<p>前面说到客户端利用<code>startService</code>进行服务启动，跟进函数。这里我们只关注<code>cfgFile</code>参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">startService</span><span class="p">(</span><span class="o">...</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cfgFile</span> <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cfgFile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="s">&#34;start frpc service for config file [%s]&#34;</span><span class="p">,</span> <span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="s">&#34;frpc service for config file [%s] stopped&#34;</span><span class="p">,</span> <span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">svr</span><span class="p">,</span> <span class="nx">errRet</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewService</span><span class="p">(</span><span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>首先是对<code>cfgFile</code>进行存在判断，然后<code>client.NewService</code>启动服务。继续跟进</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewService</span><span class="p">(</span><span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfgFile</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span><span class="nx">svr</span> <span class="o">*</span><span class="nx">Service</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">svr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Service</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cfgFile</span><span class="p">:</span>     <span class="nx">cfgFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pxyCfgs</span><span class="p">:</span>     <span class="nx">pxyCfgs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitorCfgs</span><span class="p">:</span> <span class="nx">visitorCfgs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">exit</span><span class="p">:</span>        <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">:</span>         <span class="nx">xlog</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">xlog</span><span class="p">.</span><span class="nf">New</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cancel</span><span class="p">:</span>      <span class="nx">cancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>发现<code>cfgFile</code>被指向<code>Service</code>的<code>cfgFile</code>，也就是<code>svr.cfgFile</code>。全局搜索一下被用于哪些地方。</p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://s2.loli.net/2022/12/21/k6JhnEyWpjMZ5Rg.png"
    data-srcset="https://s2.loli.net/2022/12/21/k6JhnEyWpjMZ5Rg.png, https://s2.loli.net/2022/12/21/k6JhnEyWpjMZ5Rg.png 1.5x, https://s2.loli.net/2022/12/21/k6JhnEyWpjMZ5Rg.png 2x"
    data-sizes="auto"
    alt="https://s2.loli.net/2022/12/21/k6JhnEyWpjMZ5Rg.png"
    title="https://s2.loli.net/2022/12/21/k6JhnEyWpjMZ5Rg.png"/></p>
<p>基本都源于<code>admin_api.go</code>。一处一处分析。</p>
<p>1.<code>client/admin_api.go:56</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">_</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">)</span>
</span></span></code></pre></div><p>这部分是文件解析，上部分分析过。</p>
<p>2.<code>client/admin_api.go:219</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Code</span> <span class="p">=</span> <span class="mi">400</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Msg</span> <span class="p">=</span> <span class="s">&#34;frpc has no config file path&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><p>主要是对值存在与否进行判断。</p>
<p>3.<code>client/admin_api.go:226</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">)</span>
</span></span></code></pre></div><p><code>GetRenderedConfFromFile</code>前面分析过。</p>
<p>4.<code>client/admin_api.go:277</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">)</span>
</span></span></code></pre></div><p>文件读取。</p>
<p>5.<code>client/admin_api.go:316</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">content</span><span class="p">),</span> <span class="mi">0</span><span class="nx">o644</span><span class="p">)</span>
</span></span></code></pre></div><p>向<code>svr.cfgFile</code>文件写入。</p>
<p>综合前面几部分来看，三个函数用到了配置文件。</p>
<p><code>apiReload</code>对配置文件进行加载。</p>
<p><code>apiGetConfig</code>读取配置文件。</p>
<p><code>apiPutConfig</code>函数对cfgFile进行判断，为空则写入配置文件模板。</p>
<hr>
<p>（客户端部分这里只分析了配置文件解析、使用相关过程，没有分析具体运行逻辑。</p>
<h2 id="改动思路">改动思路</h2>
<p>改动要求主要分为三部分。</p>
<p>1.改动后之前的功能均可用。不破坏之前的功能。（比如<code>admin_api.go</code>。</p>
<p>2.我们不需要配置文件。通过指定参数来满足基本要求。这里的想法是ip、server端口、remote端口以及tls值可控。</p>
<p>3.参数不能是 <code>-i 192.xxx -p 1080</code>类型，需要对参数进行整体加密，如 <code>-ts [enc]</code>（比如aes密文网上公开的tips）。</p>
<p>有了改动思路了我们就可以对代码进行浅改动了（顺便学习go。</p>
<h2 id="代码实现部分">代码实现部分</h2>
<p>首先是接收命令行部分<code>cmd/frpc/sub/root.go:79</code>,只需要给它加个参数即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">StringVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">le3</span><span class="p">,</span> <span class="s">&#34;config&#34;</span><span class="p">,</span> <span class="s">&#34;x&#34;</span><span class="p">,</span> <span class="s">&#34;[AES_Base64]&#34;</span><span class="p">,</span> <span class="s">&#34;xxx&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>参数有了，下一步我们需要给他加进某个函数，这样才能解析我们的值。这里瞄准了<code>cmd/frpc/sub/root.go:133</code>部分，这也是一开始加载文件的地方。主要改动<code>runClient</code>的调用逻辑，通过前面能发现它被调用了两次，一次是传递的是<code>path</code>参数，一次传递的<code>cfgFile</code>参数，由于<code>cfgDir</code>默认为空，第一次调用我们可以不用改动。(代码可以参考配置文件分析部分)。</p>
<p>由于它<code>runClient</code>只使用了<code>cfgFile</code>参数，这个参数是配置文件，所以它是必须参数。但我们改造完成后可以不使用它，所以我们修改这部分。</p>
<p>这里思路是通过给<code>runClient</code>参数添加可变参数，在接收到le3参数时，忽略<code>cfgFile</code>参数。首先添加可变参数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">cfgFilePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">le3Hint</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">cfgFilePath</span><span class="p">,</span> <span class="nx">le3Hint</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">startService</span><span class="p">(</span><span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">cfgFilePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>添加了然后在<code>root.go</code>修改逻辑。这里的<code>cfgFile</code>参数我们随便赋值即可，后面主要针对扩展参数进行处理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">		<span class="o">...</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">cfgFile</span> <span class="o">==</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">le3</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cfgFile</span> <span class="p">=</span> <span class="s">&#34;test&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">cfgFile</span><span class="p">,</span> <span class="nx">le3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Do not show command usage here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">err</span> <span class="o">:=</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="o">......</span>
</span></span></code></pre></div><p>然后是<code>runClient</code>函数，添加可选变量</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">cfgFilePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">le3Hint</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">cfgFilePath</span><span class="p">,</span> <span class="nx">le3Hint</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">startService</span><span class="p">(</span><span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">cfgFilePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>发现除了<code>ParseClientConfig</code>，<code>startService</code>也使用了<code>cfgFilePath</code>参数。接下来是对扩展参数的解析。</p>
<p>由于我们传入是AES的密文，需要对明/密文进行加/解密，这里同样使用map来作为传递参数的明文。也就是通过AES来加密我们的map作为传递参数。</p>
<p><code>map</code>可以算是golang的<code>json</code>，类型是键值对。</p>
<p>先写<code>AES</code>加/解密（其实只用解密即可）,参考https://juejin.cn/post/6953493716078166030</p>
<p>把加/解密写在<code>pkg/config/utils.go:55</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">PKCS7Padding</span><span class="p">(</span><span class="nx">text</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">blockSize</span> <span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//PKCS7填充
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">padding</span> <span class="o">:=</span> <span class="nx">blockSize</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="o">%</span><span class="nx">blockSize</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">padText</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">padding</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">padText</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Repeat</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{</span><span class="nb">byte</span><span class="p">(</span><span class="nx">blockSize</span><span class="p">)},</span> <span class="nx">blockSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">padText</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Repeat</span><span class="p">([]</span><span class="kt">byte</span><span class="p">{</span><span class="nb">byte</span><span class="p">(</span><span class="nx">padding</span><span class="p">)},</span> <span class="nx">padding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">append</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">padText</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">UnPKCS7Padding</span><span class="p">(</span><span class="nx">text</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//PKCS7去除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">unPadding</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">text</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="o">-</span><span class="nx">unPadding</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">AesCbcEncrypt</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">iv</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">block</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">aes</span><span class="p">.</span><span class="nf">NewCipher</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">padText</span> <span class="o">:=</span> <span class="nf">PKCS7Padding</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">block</span><span class="p">.</span><span class="nf">BlockSize</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">blockMode</span> <span class="o">:=</span> <span class="nx">cipher</span><span class="p">.</span><span class="nf">NewCBCEncrypter</span><span class="p">(</span><span class="nx">block</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">padText</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">blockMode</span><span class="p">.</span><span class="nf">CryptBlocks</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">padText</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">AesCbcDecrypt</span><span class="p">(</span><span class="nx">enc</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">iv</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">block</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">aes</span><span class="p">.</span><span class="nf">NewCipher</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">blockMode</span> <span class="o">:=</span> <span class="nx">cipher</span><span class="p">.</span><span class="nf">NewCBCDecrypter</span><span class="p">(</span><span class="nx">block</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">enc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">blockMode</span><span class="p">.</span><span class="nf">CryptBlocks</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">enc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="p">=</span> <span class="nf">UnPKCS7Padding</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>我们传入的格式是<code>[AES_Base64]</code>密文，我们可以先生成需要传入的密文。待加密的数据如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;ip&#34;</span><span class="p">:</span>  <span class="s2">&#34;192.168.1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;port&#34;</span><span class="p">:</span> <span class="s2">&#34;8088&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  	<span class="nt">&#34;rePort&#34;</span><span class="p">:</span> <span class="s2">&#34;9999&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;tls&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>用map进行传递加密。iv和key可以自己定义</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">le3</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;ip&#34;</span><span class="p">:</span>     <span class="s">&#34;192.168.1.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;port&#34;</span><span class="p">:</span>   <span class="s">&#34;8088&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;rePort&#34;</span><span class="p">:</span> <span class="s">&#34;9999&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s">&#34;tls&#34;</span><span class="p">:</span>    <span class="s">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">iv</span><span class="p">,</span> <span class="nx">key</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;16195aa289b57e22&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;8a23be48f0983bfe&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">enc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">le3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">AesCbcEncrypt</span><span class="p">(</span><span class="nx">enc</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">base64</span><span class="p">.</span><span class="nx">StdEncoding</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Kiqh2Qs/364peWaYPfkYYBeX1hyH3oi/US3S+SLhBBIhWmXlpyQV1tLFf1XDqsS2bSSlOGq3b0RU1iNViiMagw==
</span></span></span></code></pre></div><p>这是命令行传递的参数，我们需要在frp内部进行解密</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">dec</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">AesCbcDecrypt</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tmp</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">dec</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//map[ip:192.168.1.1 port:8088 rePort:9999 tls:true]
</span></span></span></code></pre></div><p>取值的话用对应键值即可。获取完参数后就可以继续对<code>ParseClientConfig</code>进行修改了。<del>通过简单if/else对<code>content</code>内容进行截取，最终重写函数内容为</del>后面发现修改<code>GetRenderedConfFromFile</code>会解决后面的问题。添加可选参数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">l3content</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">out</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">path</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">l3content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UTC</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">randStr</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">num</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">randStr</span> <span class="o">+=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">iv</span><span class="p">,</span> <span class="nx">key</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;16195aa289b57e22&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;8a23be48f0983bfe&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">encAes</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">StdEncoding</span><span class="p">.</span><span class="nf">DecodeString</span><span class="p">(</span><span class="nx">l3content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dec</span> <span class="o">:=</span> <span class="nf">AesCbcDecrypt</span><span class="p">(</span><span class="nx">encAes</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">newCfgMap</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">dec</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">newCfgMap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">newIp</span> <span class="o">:=</span> <span class="nx">newCfgMap</span><span class="p">[</span><span class="s">&#34;ip&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">newPort</span> <span class="o">:=</span> <span class="nx">newCfgMap</span><span class="p">[</span><span class="s">&#34;port&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tlsBool</span> <span class="o">:=</span> <span class="nx">newCfgMap</span><span class="p">[</span><span class="s">&#34;tls&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">RePort</span> <span class="o">:=</span> <span class="nx">newCfgMap</span><span class="p">[</span><span class="s">&#34;rePort&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`[common]
</span></span></span><span class="line"><span class="cl"><span class="s">		server_addr = `</span> <span class="o">+</span> <span class="nx">newIp</span> <span class="o">+</span> <span class="s">`
</span></span></span><span class="line"><span class="cl"><span class="s">		server_port = `</span> <span class="o">+</span> <span class="nx">newPort</span> <span class="o">+</span> <span class="s">`
</span></span></span><span class="line"><span class="cl"><span class="s">		tls_enable = `</span> <span class="o">+</span> <span class="nx">tlsBool</span> <span class="o">+</span> <span class="s">`
</span></span></span><span class="line"><span class="cl"><span class="s">		[`</span> <span class="o">+</span> <span class="nx">randStr</span> <span class="o">+</span> <span class="s">`]
</span></span></span><span class="line"><span class="cl"><span class="s">		type = tcp
</span></span></span><span class="line"><span class="cl"><span class="s">		remote_port = `</span> <span class="o">+</span> <span class="nx">RePort</span> <span class="o">+</span> <span class="s">`
</span></span></span><span class="line"><span class="cl"><span class="s">		plugin = socks5`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">RenderContent</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>然后返回来修改<code>ParseClientConfig</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">l3content</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">..</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">content</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">filePath</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">l3content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">l3content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">...............</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>到这解析基本完成。</p>
<p>但前面<code>startService</code>也调用了基础配置文件内容，前面分析过相关过程。主要是针对调用<code>svg.cfgFile</code>的几部分做修改。也就是<code>client/service.go</code>和<code>client/admin_api.go</code>部分。当然，入口处也需要更改。首先给<code>startService</code>增加可选参数。</p>
<p><code>cmd/frpc/sub/root.go</code></p>
<p>主要是<code>runClient</code>和<code>startservice</code>函数部分。加点简单if/else就行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runClient</span><span class="p">(</span><span class="nx">cfgFilePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">le3Hint</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">cfgFilePath</span><span class="p">,</span> <span class="nx">le3Hint</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">cfgFile</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">le3Hint</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">startService</span><span class="p">(</span><span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">cfgFilePath</span><span class="p">,</span> <span class="nx">le3Hint</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">startService</span><span class="p">(</span><span class="nx">cfg</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">cfgFilePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">startService</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ClientCommonConf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pxyCfgs</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">config</span><span class="p">.</span><span class="nx">ProxyConf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">visitorCfgs</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">config</span><span class="p">.</span><span class="nx">VisitorConf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfgFile</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">le3</span> <span class="o">...</span><span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">InitLog</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">LogWay</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">LogFile</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">LogLevel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cfg</span><span class="p">.</span><span class="nx">LogMaxDays</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">DisableLogColor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cfgFile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="s">&#34;start frpc service for config file [%s]&#34;</span><span class="p">,</span> <span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="s">&#34;frpc service for config file [%s] stopped&#34;</span><span class="p">,</span> <span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">le3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="s">&#34;start frpc service for le3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Trace</span><span class="p">(</span><span class="s">&#34;frpc service for le3 stopped&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></div><p>然后是<code>client.NewService</code>对<code>cfgFile</code>的调用，利用之前的方法，依然添加可选参数，处理<code>runClient</code>传入的可选参数。由于<code>NewService</code>中处理相关变量用到了结构体，所以我们需要在<code>Service</code>结构体添加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Service</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">.........</span><span class="p">..</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//other var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">le3</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="o">.........</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>然后添加可选参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewService</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="o">......</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfgFile</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">le3</span> <span class="o">...</span><span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span><span class="nx">svr</span> <span class="o">*</span><span class="nx">Service</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">svr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Service</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">authSetter</span><span class="p">:</span>  <span class="nx">auth</span><span class="p">.</span><span class="nf">NewAuthSetter</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ClientConfig</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cfg</span><span class="p">:</span>         <span class="nx">cfg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cfgFile</span><span class="p">:</span>     <span class="nx">cfgFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">le3</span><span class="p">:</span>         <span class="nx">le3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span><span class="p">..</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>跟着前面的分析思路。<code>Service</code>结构体指针指向了<code>svr</code>，所以我们还需要修改<code>svr.cfgFile</code>相关部分。也就是<code>admin_api.go</code>部分。</p>
<p>对第一处，<code>apiReload</code>函数相关部分进行改动。</p>
<p><code>client/admin_api.go:55</code>,记得添加if/else判断</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">le3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">pxyCfgs</span><span class="p">,</span> <span class="nx">visitorCfgs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ParseClientConfig</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">,</span> <span class="nx">svr</span><span class="p">.</span><span class="nx">le3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><p>然后是<code>apiGetConfig</code>函数部分。还是简单if/else</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">svr</span> <span class="o">*</span><span class="nx">Service</span><span class="p">)</span> <span class="nf">apiGetConfig</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="p">..</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">le3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Code</span> <span class="p">=</span> <span class="mi">400</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Msg</span> <span class="p">=</span> <span class="s">&#34;frpc has no config file path &amp;&amp; not le3&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">content</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">le3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">,</span> <span class="nx">svr</span><span class="p">.</span><span class="nx">le3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">GetRenderedConfFromFile</span><span class="p">(</span><span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Code</span> <span class="p">=</span> <span class="mi">400</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">.</span><span class="nx">Msg</span> <span class="p">=</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;load frpc and le3 config file error: %s &#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">.........</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>最后是<code>apiPutConfig</code>，由于他是直接读、写配置文件内容，且属于控制面版功能。对于无文件来说，暂不考虑这个问题。直接对无文件进行判断。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">svr</span><span class="p">.</span><span class="nx">cfgFile</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">svr</span><span class="p">.</span><span class="nx">le3</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><p>代码到这里就实现完成了。</p>
<p>最终大概就是。</p>
<p><strong>配置文件</strong></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://s2.loli.net/2022/12/21/KqHjIJORGzgnYw4.png"
    data-srcset="https://s2.loli.net/2022/12/21/KqHjIJORGzgnYw4.png, https://s2.loli.net/2022/12/21/KqHjIJORGzgnYw4.png 1.5x, https://s2.loli.net/2022/12/21/KqHjIJORGzgnYw4.png 2x"
    data-sizes="auto"
    alt="https://s2.loli.net/2022/12/21/KqHjIJORGzgnYw4.png"
    title="https://s2.loli.net/2022/12/21/KqHjIJORGzgnYw4.png"/></p>
<p><strong>指定参数</strong></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="https://s2.loli.net/2022/12/21/cGzwmijPrsb5VEM.png"
    data-srcset="https://s2.loli.net/2022/12/21/cGzwmijPrsb5VEM.png, https://s2.loli.net/2022/12/21/cGzwmijPrsb5VEM.png 1.5x, https://s2.loli.net/2022/12/21/cGzwmijPrsb5VEM.png 2x"
    data-sizes="auto"
    alt="https://s2.loli.net/2022/12/21/cGzwmijPrsb5VEM.png"
    title="https://s2.loli.net/2022/12/21/cGzwmijPrsb5VEM.png"/></p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2022-12-22&#32;21:13:01>更新于 2022-12-22&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://example.org/posts/frp/" data-title="frp浅改记录" data-hashtags="frp,golang"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://example.org/posts/frp/" data-hashtag="frp"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://example.org/posts/frp/" data-title="frp浅改记录" data-image="https://s2.loli.net/2022/12/21/q7BNuCyn3O1a2Gb.png"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/frp/' class="post-tag">frp</a><a href='/tags/golang/' class="post-tag">golang</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/ciscn-web-filter/" class="post-nav-item" rel="prev" title="CISCN_web_filter"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>CISCN_web_filter</a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered order-3">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.104.3">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.17-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright order-2" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="run-times ms-1">网站运行中 ...</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="right: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":20},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"typeit-header-subtitle-desktop":"web security | code review","typeit-header-subtitle-mobile":"web security | code review"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"pangu":{"enable":true,"selector":"article"},"search":{"highlightTag":"em","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50},"siteTime":"2022-12-21T16:00:00+08:00","twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},"duration":-1,"speed":100}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
